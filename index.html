<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>90 Day Habit Tracker</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at top, #2d4c7c, #0d1826);
      color: #f4f7fb;
    }
    header {
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }
    .title {
      font-size: 1.4rem;
      font-weight: 700;
    }
    .scoreboard {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .score-tile {
      background: rgba(255,255,255,.08);
      border-radius: 12px;
      padding: .5rem .8rem;
      min-width: 130px;
    }
    .score-tile small {
      color: #8da4c7;
      text-transform: uppercase;
      font-size: .6rem;
    }
    .score-tile div {
      font-size: 1.1rem;
      font-weight: 600;
    }
    main {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1rem;
      padding: 1rem;
    }
    .habits, .days {
      background: rgba(255,255,255,.05);
      border-radius: 12px;
      padding: 1rem;
    }
    .habit-card {
      display: flex;
      justify-content: space-between;
      background: rgba(255,255,255,.06);
      padding: .4rem .6rem;
      border-radius: 8px;
      margin-bottom: .5rem;
    }
    .btn-del {
      background: rgba(255,50,50,.2);
      border: none;
      color: #fff;
      border-radius: 8px;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    form {
      display: flex;
      gap: .5rem;
      margin-top: .5rem;
    }
    input, button {
      border: none;
      border-radius: 8px;
      padding: .4rem .6rem;
    }
    input {
      flex: 1;
      background: rgba(255,255,255,.08);
      color: #fff;
    }
    button {
      background: linear-gradient(120deg,#ffb347,#ff7700);
      font-weight: 600;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: .5rem;
    }
    th, td {
      padding: .4rem .3rem;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,.05);
    }
    tr.finalized {
      background: rgba(59,178,115,.2);
    }
    tr.failed {
      background: rgba(217,55,70,.2);
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #0d1826;
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 12px;
      padding: 1rem;
      width: 340px;
    }
    .modal h3 {
      margin-top: 0;
    }
    .modal input[type="number"] {
      width: 80px;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">üèí 90 Day Habit Tracker</div>
    <div class="scoreboard">
      <div class="score-tile">
        <small>Habits</small>
        <div id="sb-habits">0</div>
      </div>
      <div class="score-tile">
        <small>Kausi keskiarvo</small>
        <div id="sb-avg">‚Äî</div>
      </div>
      <div class="score-tile">
        <small>Pat Riley kasvu</small>
        <div id="sb-pr">‚Äî</div>
      </div>
    </div>
  </header>

  <main>
    <section class="habits">
      <h3>Habits / Behaviors</h3>
      <div id="habit-list"></div>
      <form id="add-form">
        <input id="habit-input" placeholder="Uusi tapa..." required />
        <button type="submit">Add</button>
      </form>
    </section>

    <section class="days">
      <h3>90 p√§iv√§n tulostaulu</h3>
      <table id="days-table">
        <thead>
          <tr><th>P√§iv√§</th><th>Suoritettu</th><th>Goal %</th><th>Score %</th><th>Finalize</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <h3 id="modal-day-title"></h3>
      <div id="modal-habits"></div>
      <div style="margin-top:.5rem;">Oma arvio Goal %:
        <input type="number" id="goal-input" min="0" max="100"> %
      </div>
      <div style="margin-top:.8rem;display:flex;justify-content:space-between;">
        <button id="btn-save">Tallenna</button>
        <button id="btn-finalize">Finalize Day</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "habit90_state_v1";
    let state = { habits: [], days: {} };

    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); updateScoreboard(); }
    function loadState() {
      const s = localStorage.getItem(STORAGE_KEY);
      if (s) state = JSON.parse(s);
      else {
        state.habits = [{id:"h1", name:"Treeni"}, {id:"h2", name:"Ruokavalio"}];
        for (let i=1;i<=90;i++){ state.days[i]={checks:{},goal:null,score:null,finalized:false};}
        saveState();
      }
    }

    // Habits
    const habitList=document.getElementById("habit-list");
    function renderHabits(){
      habitList.innerHTML="";
      state.habits.forEach(h=>{
        const div=document.createElement("div");
        div.className="habit-card";
        div.innerHTML=`<span>${h.name}</span><button class="btn-del" data-id="${h.id}">√ó</button>`;
        habitList.appendChild(div);
      });
      document.querySelectorAll(".btn-del").forEach(b=>b.onclick=()=>{
        const id=b.dataset.id;
        state.habits=state.habits.filter(h=>h.id!==id);
        Object.values(state.days).forEach(d=>delete d.checks[id]);
        saveState(); renderAll();
      });
      document.getElementById("sb-habits").textContent=state.habits.length;
    }
    document.getElementById("add-form").onsubmit=e=>{
      e.preventDefault();
      const val=document.getElementById("habit-input").value.trim();
      if(!val)return;
      state.habits.push({id:"h"+Math.random().toString(36).slice(2,7), name:val});
      document.getElementById("habit-input").value="";
      saveState(); renderAll();
    };

    // Days
    const tbody=document.querySelector("#days-table tbody");
    function renderDays(){
      tbody.innerHTML="";
      for(let i=1;i<=90;i++){
        const d=state.days[i];
        const tr=document.createElement("tr");
        if(d.finalized) tr.classList.add(d.score>= (d.goal||0)? "finalized":"failed");
        tr.innerHTML=`
          <td>Day ${i}</td>
          <td>${Object.values(d.checks).filter(Boolean).length}/${state.habits.length}</td>
          <td>${d.goal??"‚Äî"}%</td>
          <td>${d.score?d.score.toFixed(0):"‚Äî"}%</td>
          <td><button data-day="${i}">Open</button></td>`;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll("button").forEach(btn=>btn.onclick=()=>openDay(+btn.dataset.day));
    }

    // Modal
    const modal=document.getElementById("modal");
    const modalHabits=document.getElementById("modal-habits");
    const goalInput=document.getElementById("goal-input");
    let activeDay=null;

    function openDay(dayNum){
      activeDay=dayNum;
      const d=state.days[dayNum];
      modal.style.display="flex";
      document.getElementById("modal-day-title").textContent=`Day ${dayNum}`;
      modalHabits.innerHTML="";
      state.habits.forEach(h=>{
        if(!(h.id in d.checks)) d.checks[h.id]=false;
        const row=document.createElement("div");
        row.innerHTML=`<label><input type="checkbox" data-id="${h.id}" ${d.checks[h.id]?"checked":""}> ${h.name}</label>`;
        modalHabits.appendChild(row);
      });
      goalInput.value=d.goal??"";
      modalHabits.querySelectorAll("input[type=checkbox]").forEach(c=>c.onchange=()=>{
        d.checks[c.dataset.id]=c.checked;
      });
    }
    modal.onclick=e=>{if(e.target===modal) modal.style.display="none";};

    document.getElementById("btn-save").onclick=()=>{
      const d=state.days[activeDay];
      d.goal=+goalInput.value||null;
      d.finalized=false;
      saveState(); modal.style.display="none"; renderAll();
    };

    document.getElementById("btn-finalize").onclick=()=>{
      const d=state.days[activeDay];
      const done=Object.values(d.checks).filter(Boolean).length;
      const total=state.habits.length||1;
      d.score=(done/total)*100;
      d.goal=+goalInput.value||null;
      d.finalized=true;
      saveState(); modal.style.display="none"; renderAll();
    };

    // Scoreboard
    function getAvg(){
      const finals=Object.values(state.days).filter(d=>d.finalized&&d.score!=null);
      if(!finals.length)return null;
      return finals.reduce((a,b)=>a+b.score,0)/finals.length;
    }
    function updateScoreboard(){
      const avg=getAvg();
      document.getElementById("sb-avg").textContent=avg?avg.toFixed(1)+"%":"‚Äî";
      const finals=Object.values(state.days).filter(d=>d.finalized&&d.score!=null);
      if(finals.length<2){document.getElementById("sb-pr").textContent="‚Äî";return;}
      const last=finals[finals.length-1].score;
      const prevAvg=(finals.slice(0,-1).reduce((a,b)=>a+b.score,0)/(finals.length-1));
      const diff=((last-prevAvg)/prevAvg)*100;
      document.getElementById("sb-pr").textContent=(diff>=0?"+":"")+diff.toFixed(1)+"%";
    }

    function renderAll(){ renderHabits(); renderDays(); updateScoreboard(); }
    loadState(); renderAll();
  </script>
</body>
</html>
